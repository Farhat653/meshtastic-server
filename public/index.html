<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meshtastic Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;height:100vh;overflow:hidden;transition:background .3s,color .3s}
        /* ----------  dark mode (default) ---------- */
        body.dark-mode{background:#1a1a2e;color:#eee}
        body.dark-mode header{background:#16213e}
        body.dark-mode .nodes-status{background:#0f3460}
        body.dark-mode .node-badge{background:#1a1a2e}
        body.dark-mode .sidebar{background:#16213e}
        body.dark-mode .sidebar-header{background:#0f3460}
        body.dark-mode .message-card,
        body.dark-mode .position-card{background:#0f3460}
        body.dark-mode .location-entry{background:#0f3460}
        body.dark-mode .message-meta{border-top-color:#1a1a2e}
        body.dark-mode ::-webkit-scrollbar-track{background:#1a1a2e}
        body.dark-mode .leaflet-popup-content-wrapper{background:#16213e;color:#eee}
        /*  NEW: low-saturation dark map  */
        body.dark-mode .map-tiles{filter:brightness(.6) invert(1) contrast(3.5) hue-rotate(200deg) saturate(.6) brightness(.85)}
        /* ----------  light mode ---------- */
        body.light-mode{background:#f5f5f5;color:#333}
        body.light-mode header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        body.light-mode h1{color:#0066cc!important}
        body.light-mode .nodes-status{background:#e8f4f8}
        body.light-mode .node-count{color:#0066cc!important}
        body.light-mode .node-badge{background:#fff;border-color:#0066cc!important}
        body.light-mode .sidebar{background:#fff}
        body.light-mode .sidebar-header{background:#e8f4f8;color:#333}
        body.light-mode .message-card,
        body.light-mode .position-card{background:#f8f9fa;border-left-color:#0066cc!important}
        body.light-mode .location-entry{background:#f8f9fa}
        body.light-mode .message-from{color:#0066cc!important}
        body.light-mode .message-header,
        body.light-mode .location-header{color:#666}
        body.light-mode .location-node{color:#0066cc!important}
        body.light-mode .message-meta{border-top-color:#e0e0e0}
        body.light-mode ::-webkit-scrollbar-track{background:#f0f0f0}
        body.light-mode ::-webkit-scrollbar-thumb{background:#0066cc}
        body.light-mode .leaflet-popup-content-wrapper{background:#fff;color:#333}
        body.light-mode .popup-title{color:#0066cc!important}
        body.light-mode .tab-container{border-bottom-color:#0066cc}
        body.light-mode .tab.active{color:#0066cc;background:rgba(0,102,204,.1)}
        body.light-mode .tab:hover{background:rgba(0,102,204,.05)}

        .container{display:grid;grid-template-columns:1fr 400px;grid-template-rows:60px 1fr;height:100vh;transition:grid-template-columns .3s ease}
        .container.sidebar-collapsed{grid-template-columns:1fr 32px} /* arrow width only */

        header{grid-column:1/-1;padding:15px 30px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,.3);transition:background .3s}
        header h1{font-size:24px;color:#00d4ff;display:flex;align-items:center;gap:10px;transition:color .3s}
        .logo{width:40px;height:40px;object-fit:contain}
        .header-right{display:flex;align-items:center;gap:20px}

        .theme-toggle{background:transparent;border:2px solid #00d4ff;color:#00d4ff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:8px;transition:all .3s}
        .theme-toggle:hover{background:#00d4ff;color:#1a1a2e}
        body.light-mode .theme-toggle{border-color:#0066cc;color:#0066cc}
        body.light-mode .theme-toggle:hover{background:#0066cc;color:#fff}

        .nodes-status{display:flex;align-items:center;gap:12px;padding:8px 16px;border-radius:8px;transition:background .3s}
        .node-count{font-size:18px;font-weight:bold;color:#00d4ff;transition:color .3s}
        .node-list{display:flex;gap:8px;flex-wrap:wrap}
        .node-badge{padding:4px 12px;border-radius:12px;font-size:12px;display:flex;align-items:center;gap:8px;border:1px solid #00d4ff;transition:all .3s;cursor:pointer}
        .node-badge:hover{opacity:.8;transform:scale(1.05)}
        .node-battery{font-size:11px;font-weight:bold}
        .node-battery.low{color:#ff6b6b}
        .node-battery.medium{color:#ffd93d}
        .node-indicator{width:6px;height:6px;border-radius:50%;background:#00ff00}

        .status{display:flex;align-items:center;gap:8px;font-size:14px}
        .status-dot{width:10px;height:10px;border-radius:50%;background:#00ff00;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

        #map{width:100%;height:100%}

        .sidebar{display:flex;flex-direction:column;overflow:hidden;transition:background .3s,transform .3s;position:relative}
        .sidebar.collapsed{transform:translateX(calc(100% - 32px))} /* keeps arrow visible */

        .tab-container{display:flex;border-bottom:2px solid #00d4ff}
        .tab{flex:1;padding:15px 20px;background:transparent;border:none;color:#888;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s}
        .tab.active{color:#00d4ff;background:rgba(0,212,255,.1)}
        .tab:hover{background:rgba(0,212,255,.05)}

        .tab-content{display:none;flex:1;overflow-y:auto;padding:15px}
        .tab-content.active{display:block}

        .message-card{border-radius:8px;padding:12px;margin-bottom:12px;border-left:4px solid #00d4ff;animation:slideIn .3s;transition:background .3s}
        @keyframes slideIn{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}

        .message-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px;color:#aaa;transition:color .3s}
        .message-from{font-weight:bold;color:#00d4ff;transition:color .3s}
        .message-text{margin:8px 0;font-size:14px;line-height:1.4}
        .message-meta{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;color:#888;margin-top:8px;padding-top:8px;border-top:1px solid #1a1a2e;transition:all .3s}
        .meta-item{display:flex;align-items:center;gap:4px}

        .location-entry{border-radius:8px;padding:12px;margin-bottom:12px;border-left:4px solid #4ecdc4;transition:background .3s;cursor:pointer}
        .location-entry:hover{opacity:.8}
        .location-header{display:flex;justify-content:space-between;margin-bottom:8px;font-size:12px;color:#aaa}
        .location-node{font-weight:bold;color:#4ecdc4}
        .location-coords{font-size:13px;margin:4px 0}
        .location-meta{display:flex;gap:12px;flex-wrap:wrap;font-size:11px;color:#888;margin-top:8px}

        .position-card{border-radius:8px;padding:12px;margin-bottom:12px;border-left:4px solid #ff6b6b;transition:background .3s}

        .leaflet-popup-content-wrapper{transition:all .3s}
        .leaflet-popup-content{margin:10px}
        .popup-title{font-weight:bold;color:#00d4ff;margin-bottom:8px;font-size:16px;transition:color .3s}
        .popup-info{font-size:12px;line-height:1.6}
        .popup-info div{margin:4px 0}

        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{transition:background .3s}
        ::-webkit-scrollbar-thumb{background:#00d4ff;border-radius:4px;transition:background .3s}
        ::-webkit-scrollbar-thumb:hover{background:#00a8cc}

        /* ---------- NEW: arrow that lives on left edge of sidebar ---------- */
        .sidebar-arrow{
            position:absolute;
            left:0;
            top:50%;
            transform:translateY(-50%);
            width:20px;
            height:70px;
            background:#00d4ff;
            color:#1a1a2e;
            border:none;
            border-radius:0 6px 6px 0;
            cursor:pointer;
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:1001;
            transition:background .3s, left .3s;
        }
        body.light-mode .sidebar-arrow{background:#0066cc;color:#fff}
        .sidebar.collapsed .sidebar-arrow{left:100%} /* arrow sits on right edge when closed */
    </style>
</head>
<body class="dark-mode">
    <div class="container" id="mainContainer">
        <header>
            <h1>
                <img src="meshtastic.png" alt="Meshtastic Logo" class="logo">
                <span>Meshtastic Monitor</span>
            </h1>
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                    <span id="themeText">Light Mode</span>
                </button>
                <div class="nodes-status">
                    <div class="node-count"><span id="nodeCount">0</span> Nodes</div>
                    <div class="node-list" id="nodeList"></div>
                </div>
                <div class="status"><div class="status-dot"></div><span>Connected</span></div>
            </div>
        </header>

        <div id="map"></div>

        <div class="sidebar" id="sidebar">
            <button class="sidebar-arrow" id="sidebarArrow" title="Toggle sidebar">‚ñ∂</button>
            <div class="tab-container">
                <button class="tab active" data-tab="messages">Messages</button>
                <button class="tab" data-tab="locations">Location Logs</button>
            </div>
            <div class="tab-content active" id="messages-tab"></div>
            <div class="tab-content" id="locations-tab"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        const socket = io();

        /* ---------- theme ---------- */
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const body = document.body;
        const savedTheme = localStorage.getItem('theme') || 'dark-mode';
        body.className = savedTheme;
        updateThemeButton();

        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                localStorage.setItem('theme', 'light-mode');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark-mode');
            }
            updateThemeButton();
        });
        function updateThemeButton() {
            themeIcon.textContent = body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
            themeText.textContent = body.classList.contains('dark-mode') ? 'Light Mode' : 'Dark Mode';
        }

        /* ---------- map ---------- */
        const map = L.map('map').setView([1.3521, 103.8198], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19,
            className: 'map-tiles'
        }).addTo(map);

        /* ---------- sidebar toggle ---------- */
        const mainContainer = document.getElementById('mainContainer');
        const sidebar = document.getElementById('sidebar');
        const arrow = document.getElementById('sidebarArrow');
        arrow.addEventListener('click', () => {
            const close = !sidebar.classList.contains('collapsed');
            sidebar.classList.toggle('collapsed', close);
            mainContainer.classList.toggle('sidebar-collapsed', close);
            arrow.textContent = close ? '‚óÄ' : '‚ñ∂';
            map.invalidateSize();
        });

        /* ---------- tabs ---------- */
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const name = tab.dataset.tab;
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${name}-tab`).classList.add('active');
            });
        });

        /* ---------- globals ---------- */
        const markers = new Map();
        const messagesContainer = document.getElementById('messages-tab');
        const locationsContainer = document.getElementById('locations-tab');
        const nodeListContainer = document.getElementById('nodeList');
        const nodeCountElement = document.getElementById('nodeCount');
        const onlineNodes = new Map();
        const locationHistory = [];

        const nodeColors = ['#00d4ff','#ff6b6b','#4ecdc4','#ffd93d','#a8e6cf','#ff8b94','#c7ceea','#ffa07a','#98d8c8','#f7b731','#5f27cd','#00b894','#fdcb6e','#e84393','#74b9ff'];
        const nodeColorMap = new Map();
        let colorIndex = 0;
        function getNodeColor(name) {
            if (!nodeColorMap.has(name)) {
                nodeColorMap.set(name, nodeColors[colorIndex % nodeColors.length]);
                colorIndex++;
            }
            return nodeColorMap.get(name);
        }

        function updateNodeList() {
            nodeCountElement.textContent = onlineNodes.size;
            nodeListContainer.innerHTML = '';
            onlineNodes.forEach((data, name) => {
                const badge = document.createElement('div');
                badge.className = 'node-badge';
                const color = getNodeColor(name);
                badge.style.borderColor = color;
                let batteryClass = '', batteryText = '';
                if (data.battery && data.battery !== 'N/A') {
                    batteryText = data.battery;
                    const m = data.battery.match(/(\d+)%/);
                    if (m) {
                        const pct = parseInt(m[1]);
                        if (pct <= 20) batteryClass = 'low';
                        else if (pct <= 50) batteryClass = 'medium';
                    }
                }
                badge.innerHTML = `
                    <div class="node-indicator" style="background:${color}"></div>
                    <span>${name}</span>
                    ${batteryText ? `<span class="node-battery ${batteryClass}">üîã ${batteryText}</span>` : ''}
                `;
                badge.addEventListener('click', () => {
                    if (markers.has(name)) {
                        const m = markers.get(name);
                        map.setView(m.getLatLng(), 16);
                        m.openPopup();
                    }
                });
                nodeListContainer.appendChild(badge);
            });
        }

        function createNodeIcon(name) {
            const color = getNodeColor(name);
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background:${color};width:20px;height:20px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px ${color}80"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        function addMessage(msg) {
            const el = document.createElement('div');
            el.className = 'message-card';
            const color = msg.from ? getNodeColor(msg.from) : '#00d4ff';
            el.style.borderLeftColor = color;
            const time = new Date(msg.timestamp).toLocaleTimeString();
            if (msg.from) {
                onlineNodes.set(msg.from, { lastSeen: new Date(msg.timestamp), battery: msg.battery });
                updateNodeList();
            }
            el.innerHTML = `
                <div class="message-header">
                    <span class="message-from" style="color:${color}">${msg.from || 'Unknown'}</span>
                    <span>${time}</span>
                </div>
                <div class="message-text">${msg.message || ''}</div>
                <div class="message-meta">
                    ${msg.rssi && msg.rssi !== 'N/A' ? `<div>üì° RSSI: ${msg.rssi} dBm</div>` : ''}
                    ${msg.snr && msg.snr !== 'N/A' ? `<div>üì∂ SNR: ${msg.snr} dB</div>` : ''}
                    ${msg.battery && msg.battery !== 'N/A' ? `<div>üîã ${msg.battery}</div>` : ''}
                    ${msg.location ? `<div>üìç ${msg.location}</div>` : ''}
                </div>
            `;
            messagesContainer.insertBefore(el, messagesContainer.firstChild);
            while (messagesContainer.children.length > 50) messagesContainer.removeChild(messagesContainer.lastChild);
        }

        function addLocationLog(pos) {
            locationHistory.unshift(pos);
            if (locationHistory.length > 100) locationHistory.pop();
            const el = document.createElement('div');
            el.className = 'location-entry';
            const color = getNodeColor(pos.from);
            el.style.borderLeftColor = color;
            const time = new Date(pos.timestamp).toLocaleString();
            el.innerHTML = `
                <div class="location-header">
                    <span class="location-node" style="color:${color}">${pos.from || 'Unknown'}</span>
                    <span>${time}</span>
                </div>
                <div class="location-coords">üìç ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}</div>
                <div class="location-meta">
                    ${pos.altitude ? `<span>‚õ∞Ô∏è ${pos.altitude}</span>` : ''}
                    ${pos.battery && pos.battery !== 'N/A' ? `<span>üîã ${pos.battery}</span>` : ''}
                    ${pos.rssi && pos.rssi !== 'N/A' ? `<span>üì° ${pos.rssi} dBm</span>` : ''}
                    ${pos.snr && pos.snr !== 'N/A' ? `<span>üì∂ ${pos.snr} dB</span>` : ''}
                </div>
            `;
            el.addEventListener('click', () => {
                map.setView([pos.lat, pos.lng], 16);
                if (markers.has(pos.from)) markers.get(pos.from).openPopup();
            });
            locationsContainer.insertBefore(el, locationsContainer.firstChild);
            while (locationsContainer.children.length > 100) locationsContainer.removeChild(locationsContainer.lastChild);
        }

        function updatePosition(pos) {
            if (pos.from) {
                onlineNodes.set(pos.from, { lastSeen: new Date(pos.timestamp), battery: pos.battery });
                updateNodeList();
            }
            addLocationLog(pos);
            const color = getNodeColor(pos.from);
            const popup = `
                <div class="popup-title" style="color:${color}">${pos.from || 'Unknown Node'}</div>
                <div class="popup-info">
                    <div>üìç ${pos.lat.toFixed(6)}, ${pos.lng.toFixed(6)}</div>
                    ${pos.altitude ? `<div>‚õ∞Ô∏è Altitude: ${pos.altitude}</div>` : ''}
                    ${pos.battery && pos.battery !== 'N/A' ? `<div>üîã Battery: ${pos.battery}</div>` : ''}
                    ${pos.rssi && pos.rssi !== 'N/A' ? `<div>üì° RSSI: ${pos.rssi} dBm</div>` : ''}
                    ${pos.snr && pos.snr !== 'N/A' ? `<div>üì∂ SNR: ${pos.snr} dB</div>` : ''}
                    <div>üïê ${new Date(pos.timestamp).toLocaleString()}</div>
                </div>
            `;
            if (markers.has(pos.from)) {
                const m = markers.get(pos.from);
                m.setLatLng([pos.lat, pos.lng]);
                m.setPopupContent(popup);
            } else {
                const m = L.marker([pos.lat, pos.lng], { icon: createNodeIcon(pos.from) })
                    .addTo(map)
                    .bindPopup(popup);
                markers.set(pos.from, m);
            }
            if (markers.size === 1) map.setView([pos.lat, pos.lng], 13);
        }

        /* ---------- socket ---------- */
        socket.on('initial-data', data => {
            data.messages.forEach(addMessage);
            data.positions.forEach(updatePosition);
            if (markers.size > 0) {
                const bounds = L.latLngBounds(Array.from(markers.values()).map(m => m.getLatLng()));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        });
        socket.on('new-message', addMessage);
        socket.on('position-update', updatePosition);
        socket.on('disconnect', () => {
            document.querySelector('.status-dot').style.background = '#ff0000';
            document.querySelector('.status span').textContent = 'Disconnected';
        });
        socket.on('connect', () => {
            document.querySelector('.status-dot').style.background = '#00ff00';
            document.querySelector('.status span').textContent = 'Connected';
        });
        socket.on('telemetry-update', data => {
            if (data.from && data.battery) {
                if (onlineNodes.has(data.from)) onlineNodes.get(data.from).battery = data.battery;
                else onlineNodes.set(data.from, { lastSeen: new Date(data.timestamp), battery: data.battery });
                updateNodeList();
                if (markers.has(data.from)) {
                    const m = markers.get(data.from);
                    const cur = m.getPopupContent();
                    m.setPopupContent(cur.replace(/üîã Battery: [^<]+/, `üîã Battery: ${data.battery}`));
                }
            }
        });
    </script>
</body>
</html>
